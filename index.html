<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Zichtlijnen</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <style>
    html,
    body,
    html,
    body,
    #viewDiv {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #viewshedComponent {
      width: 270px;
    }

    #viewshedComponent calcite-button {
      display: flex;
    }

    #promptText {
      margin-top: 0.4rem;
    }
    .custom-tooltip .introjs-arrow {
    left: 50%; /* Center the arrow horizontally */
    transform: translateX(-50%);
    }

    .custom-tooltip {
    transform: translateX(63%) translateY(31%); /* Adjust tooltip position */
    }



/* Arrow positioning */
.custom-tooltip::after {
    content: '';
    position: absolute;
    top: 25%; /* Centers the arrow vertically */
    left: -20px; /* Places the arrow on the left side of the tooltip */
    transform: translateY(-50%); /* Adjusts to vertically center the arrow */
    border-width: 10px;
    border-style: solid;
    border-color: transparent white transparent transparent; /* Makes the left side of the arrow white */
}
  </style>
  <link href="https://unpkg.com/intro.js/minified/introjs.min.css" rel="stylesheet">
  <script src="https://unpkg.com/intro.js/minified/intro.min.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.30/"></script>
  <script type="module" src="https://js.arcgis.com/calcite-components/2.11.1/calcite.esm.js"></script>
  <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.11.1/calcite.css" />
  <script>
    require([
      "esri/Map",
      "esri/WebScene",
      "esri/views/SceneView",
      "esri/geometry/SpatialReference",
      "esri/core/promiseUtils",
      "esri/core/reactiveUtils",
      "esri/views/3d/environment/SunLighting",
      "esri/analysis/ViewshedAnalysis",
      "esri/analysis/Viewshed",
      "esri/layers/SceneLayer",
      "esri/widgets/Daylight",
      "esri/widgets/Expand",
      "esri/Basemap",
      "esri/widgets/BasemapGallery",
      "esri/widgets/Search",
      "esri/widgets/LineOfSight",
      "esri/widgets/Expand",
      "esri/geometry/Point",
      "esri/Graphic",
      "esri/core/reactiveUtils",
      "esri/widgets/Fullscreen"
    ], function(
      Map,
      WebScene,
      SceneView,
      SpatialReference,
      promiseUtils,
      reactiveUtils,
      SunLighting,
      ViewshedAnalysis,
      Viewshed,
      SceneLayer,
      Daylight,
      Expand,
      Basemap,
      BasemapGallery,
      Search, 
      LineOfSight, 
      Expand, 
      Point, 
      Graphic, 
      reactiveUtils,
      Fullscreen
    ) {
      const scene = new WebScene({
          portalItem: {
            // autocasts as new PortalItem()
            id: "586e62704afc441ead838a4abfafc2f8" //"3a9976baef9240ab8645ee25c7e9c096"
          }
        });

      const view = new SceneView({
        container: "viewDiv",
        camera: {
          position: {
            spatialReference: SpatialReference.WebMercator,
            x: 480200.5839, // -9753837.742627423,
            y: 6813500.4261, //5140806.202422867,
            z: 300 //995.4546383377165
          },
          heading: 1.2311944909542853,
          tilt: 70.07900968078631
        },
        map: scene, //new Map({basemap: "topo-3d", ground: "world-elevation"}),
        environment: {
          lighting: new SunLighting({
            date: new Date("June 18, 2024 12:50:00 UTC-6"),
            directShadowsEnabled: true
          })
        }
      });
      
      
      view.when(async () => {
        // Hide the 3D basemap's labels layer.
        const labelsLayer = view.map.basemap.referenceLayers.find(
          (layer) => layer.title === "Places and Labels"
        );
        labelsLayer.visible = true; //false
        // Create the viewshed shape.
        const viewshed = new Viewshed({
          observer: {
            spatialReference: SpatialReference.WebMercator,
            x: 480227.0214, // -9753837.742627423,
            y: 6814667.0662, //5140806.202422867,
            z: 29 //995.4546383377165
          },
          farDistance: 200, // In meters
          tilt: 84, // Tilt of 0 looks down, tilt of 90 looks parallel to the ground, tilt of 180 looks up to the sky
          heading: 63, // Counted clockwise from North
          horizontalFieldOfView: 360, //85,
          verticalFieldOfView: 120
        });
        // Initialize viewshed analysis with the created viewshed shape and add it to the view.
        const viewshedAnalysis = new ViewshedAnalysis({
          viewsheds: [viewshed]
        });
        view.analyses.add(viewshedAnalysis);
        

        
        // Access the viewshed's analysis view.
        const analysisView = await view.whenAnalysisView(viewshedAnalysis);
        // Make the existing analysis interactive and select the created viewshed.
        analysisView.interactive = true;
        analysisView.selectedViewshed = viewshed;
        // Add interactivity to the custom UI component's buttons.
        const createButton = document.getElementById("createButton");
        const cancelButton = document.getElementById("cancelButton");
        const promptText = document.getElementById("promptText");
        // Controller which allows to cancel an ongoing viewshed creation operation.
        let abortController = null;
        createButton.addEventListener("click", () => {
          // Cancel any pending creation operation.
          stopCreating();
          // Create a new abort controller for the new operation.
          abortController = new AbortController();
          updateUI();
          // Save current number of viewsheds to track whenever a new one is created.
          const viewshedCounter = viewshedAnalysis.viewsheds.length;
          // Watch whenever the a new viewshed is created and selected and then stop the creation method.
          reactiveUtils.when(
            () => viewshedAnalysis.viewsheds.length > viewshedCounter && analysisView.selectedViewshed,
            () => {
              stopCreating();
              updateUI();
            }
          );
          // Pass the controller as an argument to the interactive creation method
          // and schedule the updateUI function after creating viewsheds is finished.
          analysisView
            .createViewsheds(abortController)
            .catch((e) => {
              // When the operation is cancelled, don't do anything. Any other errors are thrown.
              if (!promiseUtils.isAbortError(e)) {
                throw e;
              }
            })
            .finally(() => {
              // Update the UI to reflect the non-creating mode.
              updateUI();
            });
        });
        cancelButton.addEventListener("click", () => {
          // Pressing the Cancel button stops the viewshed creation process and updates the UI accordingly.
          stopCreating();
          updateUI();
        });
        // Cancel the creation process and updates the UI when ESC is pressed.
        view.on("key-down", (event) => {
          if ((event.key = "Escape")) {
            stopCreating();
            updateUI();
          }
        });
        // Cancel any pending viewshed creation operation.
        function stopCreating() {
          abortController?.abort();
          abortController = null;
        }
        // Update the UI component according to whether there is a pending operation.
        function updateUI() {
          const creating = abortController != null;
          createButton.style.display = !creating ? "flex" : "none";
          cancelButton.style.display = creating ? "flex" : "none";
          promptText.style.display = creating ? "flex" : "none";
        }
        // Add the component to the UI.
        view.ui.add("viewshedComponent", "bottom-right");
      });
      
        /**************************************
       * Initialize the search widget
       **************************************/

        const searchWidget = new Search({
          allPlaceholder: "Zoek op plaats of adres",
          view: view,
          locationEnabled: false
        });

        const sources = [{
            locator: {
              url: "https://nominatim.openstreetmap.org/search",  // Nominatim API endpoint
              countryCode: 'nl',
              placeholder: "Zoek met Nominatim",
              query: function (params) {
        // Customize this function for the request format used by Nominatim
        const queryString = `q=${encodeURIComponent(params.suggestTerm)}&format=json&addressdetails=1&limit=5`;
        const searchUrl = `https://nominatim.openstreetmap.org/search?${queryString}`;

        // Perform the fetch request
        return fetch(searchUrl)
          .then(response => response.json())
          .then(data => {
            return data.map(result => ({
              name: result.display_name,
              extent: [
                [result.boundingbox[2], result.boundingbox[0]],
                [result.boundingbox[3], result.boundingbox[1]]
              ],
              feature: {
                geometry: {
                  type: "point",
                  longitude: result.lon,
                  latitude: result.lat
                },
                attributes: result
              }
            }));
          });
      },
    },
    name: "Nominatim (OpenStreetMap)", //"Geocoding Service",
    placeholder: "Zoek op plaats of adres",
    maxResults: 5,
    maxSuggestions: 6,
    suggestionsEnabled: true,
    minSuggestCharacters: 3
}];

        searchWidget.sources = sources;

        // Add the search widget to the top right corner of the view
        view.ui.add(searchWidget, {
          position: "bottom-left"
        });

        // Find the search widget in the DOM and assign an ID
        const searchElement = view.ui.find("search");
        if (searchElement) {
          searchElement.container.id = "search-tour-step";
        }

         /**************************************
       * Initialize the fullscreen widget
       **************************************/

        fullscreen = new Fullscreen({
          view: view
        });

        view.ui.add(fullscreen, "top-right");

        
        // Find the fullscreen widget in the DOM and assign an ID
        const fullscreenElement = view.ui.find("fullscreen");  
        if (fullscreenElement) {
            fullscreenElement.container.id = "fullscreen-tour-step";
        }
      
       /**************************************
       * Initialize the daylight widget
       **************************************/

      const daylight = new Daylight({
        view: view,
        // plays the animation twice as fast than the default one
        playSpeedMultiplier: 2,
        // disable the timezone selection button
        visibleElements: {
          timezone: false
        }
      });

      // Add widget inside an Expand widget to be able to hide it on devices with small screens
        const daylightExpand = new Expand({ 
          content: daylight, 
            view: view, 
            expanded: false 
        });
        
        view.ui.add(daylightExpand, "top-right");

// Assign an ID to the Expand widget's DOM node for the daylight widget
daylightExpand.domNode.id = "daylight-tour-step";

      /**************************************
       * Initialize the basemap widget
       **************************************/
      
      const basemapGallery = new BasemapGallery({
          view: view,
          source: [
            Basemap.fromId("topo-vector"), 
            Basemap.fromId("hybrid"),
            Basemap.fromId("topo-3d")
           ] // autocasts to LocalBasemapsSource
        });

      const basemapExpand = new Expand({
        expandIcon: "layers",
        view: view,
        content: basemapGallery
      })


        // Add the widget to the top-right corner of the view
        view.ui.add(basemapExpand, {
          position: "top-right"
        });

        basemapExpand.domNode.id = "basemap-tour-step";

        /**************************************
       * Initialize the Intro.js tour
       **************************************/

        // Define steps
        introJs().setOptions({
            steps: [
                { 
                    title: 'Welkom',
                    intro: "Klik op <b> verder </b> als je een korte uitleg wilt over hoe alles werkt en wat mogelijk is. <br> <br> Klik op het kruisje <b> x </b> rechtsboven om meteen te beginnen." 
                },
                { 
                    element: '.esri-ui-top-left',
                    title: 'Navigatie',
                    intro: "Hiermee kan je in- en uitzoomen, verplaatsen en roteren. <br> <br> <b> Tip: </b> <br> Je kan ook verplaatsen door met je linkermuisknop te slepen. Roteren doe je door je rechtermuisknop ingedrukt te houden en met je linkermuisknop te slepen."
                },
                { 
                    element: '.esri-ui-bottom-left',
                    title: 'Zoeken',
                    intro: "Het is nog makkelijker om de gewenste locaties op te zoeken, je wordt dan direct naar de juiste locatie gebracht. <br> <br> Je kan zoeken op plaats, adres of postcode, maar ook op namen van bekende plaatsen (bijvoorbeeld <i> het Rijksmuseum</i>)."
                },
                { 
                    element: '#basemap-tour-step',
                    title: 'Ondergrond',
                    intro: "Klik hier om een andere kaart als ondergrond te kiezen (bijvoorbeeld een luchtfoto). <br> <br> <b> Let op: </b> <br> Alleen als je een zichtlijn in het <b>buitenland</b> wilt maken, moet je hier de meest rechter kaart kiezen (Topographic 3D). In Nederland kan je deze beter niet gebruiken, aangezien deze minder nauwkeurig is."
                },
                { 
                    element: '#daylight-tour-step',
                    title: 'Belichting',
                    intro: "Klik hier om de belichting aan te passen. <br> <br> <b> Tip: </b> <br> Je kan zelfs een specifieke dag en tijdstip aangeven."
                },
                { 
                    element: '#viewshedComponent',
                    title: 'Nieuwe zichtlijn', 
                    intro: "Klik hier om een nieuwe zichtlijn te maken. Alles wat zichtbaar is wordt groen en de rest rood. <br> <br> <b> Stap voor stap: </b> <br> 1. Klik op de locatie observant. <br><br> 2. Sleep zichtlijn in gewenste richting. <br><br> 3. Pas de grootte van de horzintale en verticale hoek aan door de oranje lijnen (aan het uiteinde van de zichtlijn) te slepen."
                },
                {
                    position: 'right',
                    tooltipClass: 'custom-tooltip',
                    title: 'Zichtlijn verwijderen',
                    intro: 'Je kan oude zichtlijnen gemakkelijk verwijderen. <br> <br> <b> Stap voor stap: </b> <br> 1. Selecteer de oude zichtlijn door op de oranje cirkel op de plaats van de observant te klikken, in de huidige zichtlijn is dat het midden. <br> <br> 2. Druk op de knop delete of backspace. <br> <br> Tijd om te beginnen!'
                }
      // Add more steps as needed
            ],
            nextLabel: 'Verder', // Changes 'Next' to 'Volgende'
            prevLabel: 'Terug', // Changes 'Back' to 'Sla over'
            skipLabel: 'x', // Changes 'Skip' to 'Overslaan'
            doneLabel: 'Klaar', // Changes 'Done' to 'Klaar'
            showProgress: false,
            showBullets: true
        }).start(); 
      
    });
    

  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <calcite-card id="viewshedComponent">
    <calcite-button id="createButton">Maak nieuwe zichtlijn</calcite-button>
    <calcite-button id="cancelButton" style="display:none">Cancel </calcite-button>
    <div id="promptText" style="display: none">
      <em>Start de analyse door te klikken waar de observant staat en vervolgens in de richting van de target te bewegen.</em>
    </div>
  </calcite-card>
</body>

</html>